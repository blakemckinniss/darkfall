<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>localStorage Debounce Test</title>
    <style>
        body { font-family: monospace; padding: 20px; }
        .test { margin: 20px 0; padding: 10px; border: 1px solid #ccc; }
        .pass { background: #d4edda; }
        .fail { background: #f8d7da; }
        button { margin: 5px; padding: 10px; }
        pre { background: #f5f5f5; padding: 10px; }
    </style>
</head>
<body>
    <h1>localStorage Debounce Test</h1>
    <p>Testing the debounced save mechanism to ensure no data loss</p>

    <div id="results"></div>

    <button onclick="runTests()">Run All Tests</button>
    <button onclick="localStorage.clear()">Clear localStorage</button>

    <script>
        const GAME_STATE_KEY = 'blackfell_game_state_test';
        let saveTimeoutRef = null;

        // Simulated debounced save function (matches component behavior)
        function saveGameState(state) {
            return new Promise((resolve) => {
                clearTimeout(saveTimeoutRef);
                saveTimeoutRef = setTimeout(() => {
                    try {
                        localStorage.setItem(GAME_STATE_KEY, JSON.stringify(state));
                        console.log('Saved:', state);
                        resolve();
                    } catch (error) {
                        console.error('Failed to save:', error);
                    }
                }, 500);
            });
        }

        function loadGameState() {
            try {
                const saved = localStorage.getItem(GAME_STATE_KEY);
                return saved ? JSON.parse(saved) : null;
            } catch (error) {
                console.error('Failed to load:', error);
                return null;
            }
        }

        async function test1_rapidUpdates() {
            console.log('Test 1: Rapid state updates (simulating combat)');
            const results = [];

            // Simulate 10 rapid state changes
            for (let i = 0; i < 10; i++) {
                saveGameState({ health: 100 - i, turn: i });
                results.push(i);
            }

            // Wait for debounce to complete
            await new Promise(resolve => setTimeout(resolve, 600));

            const saved = loadGameState();
            const pass = saved && saved.health === 91 && saved.turn === 9;

            return {
                name: 'Rapid Updates Test',
                pass,
                details: `Expected final state: health=91, turn=9. Got: ${JSON.stringify(saved)}`
            };
        }

        async function test2_quickTabClose() {
            console.log('Test 2: Quick tab close scenario');

            // Simulate state change
            saveGameState({ gold: 100, level: 5 });

            // Wait only 200ms (less than 500ms debounce)
            await new Promise(resolve => setTimeout(resolve, 200));

            // Check if save is still pending
            const immediate = loadGameState();

            // Wait for full debounce
            await new Promise(resolve => setTimeout(resolve, 400));

            const final = loadGameState();
            const pass = final && final.gold === 100 && final.level === 5;

            return {
                name: 'Tab Close Test',
                pass,
                details: `Immediate check: ${JSON.stringify(immediate)}, Final: ${JSON.stringify(final)}`
            };
        }

        async function test3_multipleFastUpdates() {
            console.log('Test 3: Multiple fast updates with pauses');

            // First update
            saveGameState({ inventory: ['sword'] });
            await new Promise(resolve => setTimeout(resolve, 300));

            // Second update (should cancel first)
            saveGameState({ inventory: ['sword', 'shield'] });
            await new Promise(resolve => setTimeout(resolve, 300));

            // Third update (should cancel second)
            saveGameState({ inventory: ['sword', 'shield', 'potion'] });
            await new Promise(resolve => setTimeout(resolve, 600));

            const saved = loadGameState();
            const pass = saved && saved.inventory && saved.inventory.length === 3;

            return {
                name: 'Multiple Fast Updates',
                pass,
                details: `Expected 3 items. Got: ${JSON.stringify(saved)}`
            };
        }

        async function test4_largeStateObject() {
            console.log('Test 4: Large state object (performance test)');
            const start = performance.now();

            const largeState = {
                inventory: Array.from({ length: 100 }, (_, i) => ({
                    id: `item-${i}`,
                    name: `Item ${i}`,
                    stats: { attack: i, defense: i }
                })),
                generatedPortraits: Array.from({ length: 10 }, (_, i) => ({
                    id: `portrait-${i}`,
                    url: 'https://example.com/portrait.jpg',
                    timestamp: Date.now()
                }))
            };

            saveGameState(largeState);
            await new Promise(resolve => setTimeout(resolve, 600));

            const end = performance.now();
            const saved = loadGameState();
            const pass = saved && saved.inventory.length === 100 && end - start < 1000;

            return {
                name: 'Large State Performance',
                pass,
                details: `Saved and loaded in ${(end - start).toFixed(2)}ms. State size: ${JSON.stringify(saved).length} bytes`
            };
        }

        async function runTests() {
            const resultsDiv = document.getElementById('results');
            resultsDiv.innerHTML = '<p>Running tests...</p>';

            localStorage.clear();

            const tests = [
                test1_rapidUpdates,
                test2_quickTabClose,
                test3_multipleFastUpdates,
                test4_largeStateObject
            ];

            const results = [];
            for (const test of tests) {
                const result = await test();
                results.push(result);
                console.log(result);
            }

            // Display results
            let html = '<h2>Test Results</h2>';
            results.forEach(result => {
                html += `
                    <div class="test ${result.pass ? 'pass' : 'fail'}">
                        <h3>${result.pass ? '✅' : '❌'} ${result.name}</h3>
                        <pre>${result.details}</pre>
                    </div>
                `;
            });

            const passed = results.filter(r => r.pass).length;
            html += `<p><strong>Results: ${passed}/${results.length} tests passed</strong></p>`;

            resultsDiv.innerHTML = html;
        }

        // Run tests automatically
        window.addEventListener('load', runTests);
    </script>
</body>
</html>
